# CD Staging Pipeline - Runs when code is merged to ci-main
# Deploys to staging and creates PR to cd-main

name: CD Staging

on:
  push:
    branches: [ci-main]

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Staging deployment complete
        run: echo "Staging build successful! ðŸš€"

  # Create PR to cd-main after staging deployment
  promote-to-cd:
    name: Create PR to cd-main
    needs: deploy-staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request to cd-main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base cd-main --head ci-main --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base cd-main \
              --head ci-main \
              --title "CD: Promote ci-main to cd-main" \
              --body "Automated PR from CD Staging pipeline.

**Source:** \`ci-main\`
**Target:** \`cd-main\`

Staging build successful âœ…
Ready for final testing before production."
            echo "PR created successfully"
          else
            echo "PR #$EXISTING_PR already exists"
          fi
